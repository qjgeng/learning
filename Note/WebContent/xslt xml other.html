<html>
<head>
  <title>xslt xml other</title>
  <basefont face="Tahoma" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/220395 (en-US); Windows/6.1.7601 Service Pack 1;"/>
  <style>
    body, td {
      font-family: Tahoma;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="1617"/>
<h1>xslt xml other</h1>

<div>
<div style="word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;"><div align="left"><font color="#808080" face="Consolas" size="1"><span style="font-size:8pt">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></font></div><div align="left"><font color="#0000FF" face="Consolas" size="1"><span style="font-size:8pt">&lt;xsl:stylesheet version=</span></font><font color="#800000" face="Consolas" size="1"><span style="font-size:8pt">&quot;2.0&quot;</span></font> <font color="#0000FF" face="Consolas" size="1"><span style="font-size:8pt">xmlns:xsl=</span></font><font color="#800000" face="Consolas" size="1"><span style="font-size:8pt">&quot;http://www.w3.org/1999/XSL/Transform&quot;</span></font> <font color="#0000FF" face="Consolas" size="1"><span style="font-size:8pt">xmlns=</span></font><font color="#800000" face="Consolas" size="1"><span style="font-size:8pt">&quot;urn:hl7-org:v3&quot;</span></font> <font color="#0000FF" face="Consolas" size="1"><span style="font-size:8pt">xmlns:core=</span></font><font color="#800000" face="Consolas" size="1"><span style="font-size:8pt">&quot;http://www.altova.com/MapForce/UDF/core&quot;</span></font> <font color="#0000FF" face="Consolas" size="1"><span style="font-size:8pt">xmlns:xsi=</span></font><font color="#800000" face="Consolas" size="1"><span style="font-size:8pt">&quot;http://www.w3.org/2001/XMLSchema&quot;</span></font> <font color="#0000FF" face="Consolas" size="1"><span style="font-size:8pt">xmlns:fn=</span></font><font color="#800000" face="Consolas" size="1"><span style="font-size:8pt">&quot;http://www.w3.org/2005/xpath-functions&quot;</span></font> <font color="#0000FF" face="Consolas" size="1"><span style="font-size:8pt">xmlns:ns0=</span></font><font color="#800000" face="Consolas" size="1"><span style="font-size:8pt">&quot;urn:hl7-org:v3&quot;</span></font> <font color="#0000FF" face="Consolas" size="1"><span style="font-size:8pt">exclude-result-prefixes=</span></font><font color="#800000" face="Consolas" size="1"><span style="font-size:8pt">&quot;core xsi fn ns0&quot;</span></font><font color="#0000FF" face="Consolas" size="1"><span style="font-size:8pt">&gt;</span></font></div><div align="left"><font face="Consolas" size="1"><span style="font-size:8pt">        </span></font><font color="#0000FF" face="Consolas" size="1"><span style="font-size:8pt">&lt;xsl:output method=</span></font><font color="#800000" face="Consolas" size="1"><span style="font-size:8pt">&quot;xml&quot;</span></font> <font color="#0000FF" face="Consolas" size="1"><span style="font-size:8pt">encoding=</span></font><font color="#800000" face="Consolas" size="1"><span style="font-size:8pt">&quot;UTF-8&quot;</span></font> <font color="#0000FF" face="Consolas" size="1"><span style="font-size:8pt">indent=</span></font><font color="#800000" face="Consolas" size="1"><span style="font-size:8pt">&quot;yes&quot;</span></font><font color="#0000FF" face="Consolas" size="1"><span style="font-size:8pt">/&gt;</span></font><font face="Consolas" size="1"><span style="font-size:8pt">     </span></font></div><div align="left"><font face="Consolas" size="1"><span style="font-size:8pt">        </span></font><font color="#0000FF" face="Consolas" size="1"><span style="font-size:8pt">&lt;xsl:param name=</span></font><font color="#800000" face="Consolas" size="1"><span style="font-size:8pt">&quot;patientIdOid&quot;</span></font><font color="#0000FF" face="Consolas" size="1"><span style="font-size:8pt">/&gt;</span></font></div><div align="left"><font face="Consolas" size="1"><span style="font-size:8pt">        </span></font><font color="#0000FF" face="Consolas" size="1"><span style="font-size:8pt">&lt;xsl:variable name=</span></font><font color="#800000" face="Consolas" size="1"><span style="font-size:8pt">&quot;patientIdCount&quot;</span></font> <font color="#0000FF" face="Consolas" size="1"><span style="font-size:8pt">select=</span></font><font color="#800000" face="Consolas" size="1"><span style="font-size:8pt">&quot;count(ns0:ClinicalDocument/ns0:recordTarget/ns0:patientRole/ns0:id)&quot;</span></font><font color="#0000FF" face="Consolas" size="1"><span style="font-size:8pt">/&gt;</span></font></div><div align="left"><font face="Consolas" size="1"><span style="font-size:8pt">        </span></font><font color="#0000FF" face="Consolas" size="1"><span style="font-size:8pt">&lt;xsl:template match=</span></font><font color="#800000" face="Consolas" size="1"><span style="font-size:8pt">&quot;@*|node()&quot;</span></font><font color="#0000FF" face="Consolas" size="1"><span style="font-size:8pt">&gt;</span></font><font face="Consolas" size="1"><span style="font-size:8pt">                        </span></font></div><div align="left"><font face="Consolas" size="1"><span style="font-size:8pt">               </span></font><font color="#0000FF" face="Consolas" size="1"><span style="font-size:8pt">&lt;xsl:copy&gt;</span></font></div><div align="left"><font face="Consolas" size="1"><span style="font-size:8pt">                       </span></font><font color="#0000FF" face="Consolas" size="1"><span style="font-size:8pt">&lt;xsl:apply-templates select=</span></font><font color="#800000" face="Consolas" size="1"><span style="font-size:8pt">&quot;@* | node()&quot;</span></font><font color="#0000FF" face="Consolas" size="1"><span style="font-size:8pt">/&gt;</span></font></div><div align="left"><font face="Consolas" size="1"><span style="font-size:8pt">               </span></font><font color="#0000FF" face="Consolas" size="1"><span style="font-size:8pt">&lt;/xsl:copy&gt;</span></font></div><div align="left"><font face="Consolas" size="1"><span style="font-size:8pt">        </span></font><font color="#0000FF" face="Consolas" size="1"><span style="font-size:8pt">&lt;/xsl:template&gt;</span></font><font face="Consolas" size="1"><span style="font-size:8pt">               </span></font></div><div align="left"><font face="Consolas" size="1"><span style="font-size:8pt">        </span></font><font color="#0000FF" face="Consolas" size="1"><span style="font-size:8pt">&lt;xsl:template match=</span></font><font color="#800000" face="Consolas" size="1"><span style="font-size:8pt">&quot;ns0:ClinicalDocument/ns0:recordTarget/ns0:patientRole/ns0:id&quot;</span></font><font color="#0000FF" face="Consolas" size="1"><span style="font-size:8pt">&gt;</span></font></div><div align="left"><font face="Consolas" size="1"><span style="font-size:8pt">               </span></font><font color="#0000FF" face="Consolas" size="1"><span style="font-size:8pt">&lt;xsl:if test=</span></font><font color="#800000" face="Consolas" size="1"><span style="font-size:8pt">&quot;$patientIdCount=1 or $patientIdCount &amp;lt; 1 &quot;</span></font><font color="#0000FF" face="Consolas" size="1"><span style="font-size:8pt">&gt;</span></font></div><div align="left"><font face="Consolas" size="1"><span style="font-size:8pt">                  </span></font> <font color="#0000FF" face="Consolas" size="1"><span style="font-size:8pt">&lt;xsl:copy-of select=</span></font><font color="#800000" face="Consolas" size="1"><span style="font-size:8pt">&quot;.&quot;</span></font><font color="#0000FF" face="Consolas" size="1"><span style="font-size:8pt">/&gt;</span></font></div><div align="left"><font face="Consolas" size="1"><span style="font-size:8pt">               </span></font><font color="#0000FF" face="Consolas" size="1"><span style="font-size:8pt">&lt;/xsl:if&gt;</span></font></div><div align="left"><font face="Consolas" size="1"><span style="font-size:8pt">               </span></font><font color="#0000FF" face="Consolas" size="1"><span style="font-size:8pt">&lt;xsl:if test=</span></font><font color="#800000" face="Consolas" size="1"><span style="font-size:8pt">&quot;$patientIdCount &amp;gt; 1&quot;</span></font><font color="#0000FF" face="Consolas" size="1"><span style="font-size:8pt">&gt;</span></font></div><div align="left"><font face="Consolas" size="1"><span style="font-size:8pt">                       </span></font><font color="#0000FF" face="Consolas" size="1"><span style="font-size:8pt">&lt;xsl:choose&gt;</span></font></div><div align="left"><font face="Consolas" size="1"><span style="font-size:8pt">                          </span></font> <font color="#0000FF" face="Consolas" size="1"><span style="font-size:8pt">&lt;xsl:when test=</span></font><font color="#800000" face="Consolas" size="1"><span style="font-size:8pt">&quot;@root=$patientIdOid&quot;</span></font><font color="#0000FF" face="Consolas" size="1"><span style="font-size:8pt">&gt;</span></font></div><div align="left"><font face="Consolas" size="1"><span style="font-size:8pt">                              </span></font> <font color="#0000FF" face="Consolas" size="1"><span style="font-size:8pt">&lt;xsl:copy-of select=</span></font><font color="#800000" face="Consolas" size="1"><span style="font-size:8pt">&quot;.&quot;</span></font><font color="#0000FF" face="Consolas" size="1"><span style="font-size:8pt">/&gt;</span></font></div><div align="left"><font face="Consolas" size="1"><span style="font-size:8pt">                          </span></font> <font color="#0000FF" face="Consolas" size="1"><span style="font-size:8pt">&lt;/xsl:when&gt;</span></font></div><div align="left"><font face="Consolas" size="1"><span style="font-size:8pt">                       </span></font><font color="#0000FF" face="Consolas" size="1"><span style="font-size:8pt">&lt;/xsl:choose&gt;</span></font></div><div align="left"><font face="Consolas" size="1"><span style="font-size:8pt">               </span></font><font color="#0000FF" face="Consolas" size="1"><span style="font-size:8pt">&lt;/xsl:if&gt;</span></font></div><div align="left"><font face="Consolas" size="1"><span style="font-size:8pt">        </span></font><font color="#0000FF" face="Consolas" size="1"><span style="font-size:8pt">&lt;/xsl:template&gt;</span></font></div><div align="left"><font color="#0000FF" face="Consolas" size="1"><span style="font-size:8pt">&lt;/xsl:stylesheet&gt;</span></font></div><div align="left"><font color="#0000FF" face="Consolas" size="1"><span style="font-size:8pt"><br></span></font></div><div align="left"><font color="#0000FF" face="Consolas" size="1"><span style="font-size:8pt"><br></span></font></div><div align="left"><font color="#0000FF" face="Consolas" size="1"><span style="font-size:8pt">------------------------------------------------------------------------------------------------------------</span></font></div><div align="left"><div align="left" style="font-size: 13px;"><font color="#0000FF" face="Consolas"><font face="Consolas">        </font><font color="#7F0055" face="Consolas"><b>public</b></font> <font face="Consolas">String filterPatients(String ccda, String tpId)</font> <font color="#7F0055" face="Consolas"><b>throws</b></font> <font face="Consolas">Exception {</font></font></div><div align="left" style="font-size: 13px;"><font color="#0000FF" face="Consolas"><font face="Consolas">               DocumentBuilderFactory documentBuilderFactory = DocumentBuilderFactory.newInstance();</font></font></div><div align="left" style="font-size: 13px;"><font color="#0000FF" face="Consolas"><font face="Consolas">               Document doc =</font> <font color="#7F0055" face="Consolas"><b>null</b></font><font face="Consolas">;</font></font></div><div align="left" style="font-size: 13px;"><font color="#0000FF" face="Consolas"><font face="Consolas">               </font><font color="#7F0055" face="Consolas"><b>try</b></font> <font face="Consolas">{</font></font></div><div align="left" style="font-size: 13px;"><font color="#0000FF" face="Consolas"><font face="Consolas">                       doc = documentBuilderFactory.newDocumentBuilder().parse(</font><font color="#7F0055" face="Consolas"><b>new</b></font> <font face="Consolas">ByteArrayInputStream(ccda.getBytes()));</font></font></div><div align="left" style="font-size: 13px;"><font color="#0000FF" face="Consolas"><font face="Consolas">               }</font> <font color="#7F0055" face="Consolas"><b>catch</b></font> <font face="Consolas">(Exception e) {</font></font></div><div align="left" style="font-size: 13px;"><font color="#0000FF" face="Consolas"><font face="Consolas">                       LOG.warn(</font><font color="#2A00FF" face="Consolas">&quot;Could not parse ccda, ccda= &quot;</font> <font face="Consolas">+ ccda);</font></font></div><div align="left" style="font-size: 13px;"><font color="#0000FF" face="Consolas"><font face="Consolas">                       </font><font color="#7F0055" face="Consolas"><b>throw</b></font> <font color="#7F0055" face="Consolas"><b>new</b></font> <font face="Consolas">RuntimeException(</font><font color="#2A00FF" face="Consolas">&quot;Could not parse ccda.&quot;</font><font face="Consolas">);</font></font></div><div align="left" style="font-size: 13px;"><font color="#0000FF" face="Consolas"><font face="Consolas">               }</font></font></div><div align="left" style="font-size: 13px;"><font color="#0000FF" face="Consolas"><font color="#010101" face="Consolas"><br></font></font></div><div align="left" style="font-size: 13px;"><font color="#0000FF" face="Consolas"><font face="Consolas">               String path =</font> <font color="#2A00FF" face="Consolas">&quot;/ClinicalDocument/recordTarget/patientRole/id&quot;</font><font face="Consolas">;</font></font></div><div align="left" style="font-size: 13px;"><font color="#0000FF" face="Consolas"><font face="Consolas">               XPathExpression xPath = XPathFactory.newInstance().newXPath().compile(path);</font></font></div><div align="left" style="font-size: 13px;"><font color="#0000FF" face="Consolas"><font face="Consolas">               NodeList patientNodeLst = (NodeList) xPath.evaluate(doc, XPathConstants.NODESET);</font></font></div><div align="left" style="font-size: 13px;"><font color="#0000FF" face="Consolas"><font face="Consolas">               </font><font color="#3F7F5F" face="Consolas">// filter patients if result&gt;1</font></font></div><div align="left" style="font-size: 13px;"><font color="#0000FF" face="Consolas"><font face="Consolas">               </font><font color="#7F0055" face="Consolas"><b>if</b></font><font face="Consolas">(patientNodeLst!=</font><font color="#7F0055" face="Consolas"><b>null</b></font><font face="Consolas">&amp;&amp;patientNodeLst.getLength()&gt;1) {</font></font></div><div align="left" style="font-size: 13px;"><font color="#0000FF" face="Consolas"><font face="Consolas">                       LOG.info(</font><font color="#2A00FF" face="Consolas">&quot;Filter patient nodes by tpId, tpId= &quot;</font> <font face="Consolas">+ tpId);</font></font></div><div align="left" style="font-size: 13px;"><font color="#0000FF" face="Consolas"><font face="Consolas">                       String oid = crosswalkService.getPatientOidBySourceId(tpId);</font></font></div><div align="left" style="font-size: 13px;"><font color="#0000FF" face="Consolas"><font face="Consolas">                       List&lt;Node&gt; toDelete =</font> <font color="#7F0055" face="Consolas"><b>new</b></font> <font face="Consolas">ArrayList&lt;Node&gt;();</font></font></div><div align="left" style="font-size: 13px;"><font color="#0000FF" face="Consolas"><font face="Consolas">                       </font><font color="#3F7F5F" face="Consolas">// find node to delete</font></font></div><div align="left" style="font-size: 13px;"><font color="#0000FF" face="Consolas"><font face="Consolas">                       </font><font color="#7F0055" face="Consolas"><b>for</b></font><font face="Consolas">(</font><font color="#7F0055" face="Consolas"><b>int</b></font> <font face="Consolas">ix=0;ix&lt;patientNodeLst.getLength();ix++) {</font></font></div><div align="left" style="font-size: 13px;"><font color="#0000FF" face="Consolas"><font face="Consolas">                              Node node = patientNodeLst.item(ix);</font></font></div><div align="left" style="font-size: 13px;"><font color="#0000FF" face="Consolas"><font face="Consolas">                              String currentOid = node.getAttributes().getNamedItem(</font><font color="#2A00FF" face="Consolas">&quot;root&quot;</font><font face="Consolas">).getNodeValue();</font></font></div><div align="left" style="font-size: 13px;"><font color="#0000FF" face="Consolas"><font face="Consolas">                              </font><font color="#7F0055" face="Consolas"><b>if</b></font><font face="Consolas">(!currentOid.equalsIgnoreCase(oid)) {</font></font></div><div align="left" style="font-size: 13px;"><font color="#0000FF" face="Consolas"><font face="Consolas">                                      toDelete.add(node);</font></font></div><div align="left" style="font-size: 13px;"><font color="#0000FF" face="Consolas"><font face="Consolas">                              }                             </font></font></div><div align="left" style="font-size: 13px;"><font color="#0000FF" face="Consolas"><font face="Consolas">                       }</font></font></div><div align="left" style="font-size: 13px;"><font color="#0000FF" face="Consolas"><font face="Consolas">                       </font><font color="#3F7F5F" face="Consolas">// do delete</font></font></div><div align="left" style="font-size: 13px;"><font color="#0000FF" face="Consolas"><font face="Consolas">                       </font><font color="#7F0055" face="Consolas"><b>for</b></font><font face="Consolas">(Node node:toDelete){</font></font></div><div align="left" style="font-size: 13px;"><font color="#0000FF" face="Consolas"><font face="Consolas">                              node.getParentNode().removeChild(node);</font></font></div><div align="left" style="font-size: 13px;"><font color="#0000FF" face="Consolas"><font face="Consolas">                       }</font></font></div><div align="left" style="font-size: 13px;"><font color="#0000FF" face="Consolas"><font face="Consolas">                       </font><font color="#3F7F5F" face="Consolas">// output ccda</font></font></div><div align="left" style="font-size: 13px;"><font color="#0000FF" face="Consolas"><font face="Consolas">                       Transformer tf = TransformerFactory.newInstance().newTransformer();</font></font></div><div align="left" style="font-size: 13px;"><font color="#0000FF" face="Consolas"><font face="Consolas">                tf.setOutputProperty(OutputKeys.ENCODING,</font> <font color="#2A00FF" face="Consolas">&quot;UTF-8&quot;</font><font face="Consolas">);</font></font></div><div align="left" style="font-size: 13px;"><font color="#0000FF" face="Consolas"><font face="Consolas">                Writer out =</font> <font color="#7F0055" face="Consolas"><b>new</b></font> <font face="Consolas">StringWriter();</font></font></div><div align="left" style="font-size: 13px;"><font color="#0000FF" face="Consolas"><font face="Consolas">                tf.transform(</font><font color="#7F0055" face="Consolas"><b>new</b></font> <font face="Consolas">DOMSource(doc),</font> <font color="#7F0055" face="Consolas"><b>new</b></font> <font face="Consolas">StreamResult(out));</font></font></div><div align="left" style="font-size: 13px;"><font color="#0000FF" face="Consolas"><font face="Consolas">                ccda = out.toString();</font></font></div><div align="left" style="font-size: 13px;"><font color="#0000FF" face="Consolas"><font face="Consolas">                out.close();   </font></font></div><div align="left" style="font-size: 13px;"><font color="#0000FF" face="Consolas"><font face="Consolas">               }</font></font></div><div align="left" style="font-size: 13px;"><font color="#0000FF" face="Consolas"><font face="Consolas">               </font><font color="#7F0055" face="Consolas"><b>return</b></font> <font face="Consolas">ccda;</font></font></div><div align="left" style="font-size: 13px;"><font color="#0000FF" face="Consolas"><font face="Consolas">        }</font></font></div></div></div>
</div></body></html> 